from __future__ import annotations
from datetime import datetime
import random
from typing import Optional

import counter
from ai_helper import get_ai_advice


# ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¾Ğ² -> Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ° (placeholder)
SHOP_LINKS = {
    "5": "https://yandex.ru/maps/?text=Ğ¿ÑÑ‚ĞµÑ€Ğ¾Ñ‡ĞºĞ°",
    "Ğ¿ÑÑ‚ĞµÑ€Ğ¾Ñ‡ĞºĞ°": "https://yandex.ru/maps/?text=Ğ¿ÑÑ‚ĞµÑ€Ğ¾Ñ‡ĞºĞ°",
    "Ğ¼Ğ°Ğ³Ğ½Ğ¸Ñ‚": "https://yandex.ru/maps/?text=Ğ¼Ğ°Ğ³Ğ½Ğ¸Ñ‚",
    "Ğ¿ĞµÑ€ĞµĞºÑ€ĞµÑÑ‚Ğ¾Ğº": "https://yandex.ru/maps/?text=Ğ¿ĞµÑ€ĞµĞºÑ€ĞµÑÑ‚Ğ¾Ğº",
    "Ğ¿ĞµÑ€ĞµĞº": "https://yandex.ru/maps/?text=Ğ¿ĞµÑ€ĞµĞºÑ€ĞµÑÑ‚Ğ¾Ğº",
    "Ğ»ĞµĞ½Ñ‚Ğ°": "https://yandex.ru/maps/?text=Ğ»ĞµĞ½Ñ‚Ğ°",
    "Ğ´Ğ¸ĞºÑĞ¸": "https://yandex.ru/maps/?text=Ğ´Ğ¸ĞºÑĞ¸",
}


KS_CONTACTS = [
    "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜.Ğ˜. â€” +7 900 000-00-01",
    "ĞŸĞµÑ‚Ñ€Ğ¾Ğ² ĞŸ.ĞŸ. â€” +7 900 000-00-02",
    "Ğ¡Ğ¸Ğ´Ğ¾Ñ€Ğ¾Ğ² Ğ¡.Ğ¡. â€” +7 900 000-00-03",
]


BLOHA_CHOICES = [
    "Ğ”Ğ",
    "Ğ½ĞµÑ‚",
]


HELP_TEXT = (
    "Ğ¡ Ğ²Ğ°Ğ¼Ğ¸ Ñ€Ğ°Ğ´Ğ¸Ğ¾ 109.9 FM ğŸ™\n" 
    "Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´:\n"
    "- !ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹, !Ğ¼ĞµĞ½Ñ, !Ñ„Ğ°ĞºÑ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ\n"
    "- !Ğ´ĞµĞ¼Ğ±ĞµĞ»ÑŒ â€” ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ»ÑƒĞ¶Ğ¸Ñ‚ÑŒ\n"
    "- !ÑĞµĞ·Ğ¾Ğ½ â€” Ğ´Ğ½Ğ¸ Ğ´Ğ¾ ÑĞµĞ·Ğ¾Ğ½Ğ°\n"
    "- !Ğ·Ñ…Ğ´ â€” Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚\n"
    "- !Ğ±Ğ»Ğ¾Ñ…Ğ° â€” Ğ´Ğ°Ğ¼ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ² ÑĞ¿Ğ¾Ñ€Ğ½Ğ¾Ğ¹ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸\n"
    "- !ĞºÑ â€” Ğ¤Ğ˜Ğ ĞºĞ¾Ğ¼ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ° Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°\n"
    "- !Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ â€” Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑƒ ÑĞ¿Ğ¾Ñ€ Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ğ¾Ğ¹\n"
    "- !Ğ²Ñ€ĞµĞ¼Ñ â€” ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ\n"
    "ĞšĞ°Ñ€Ñ‚Ñ‹ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¾Ğ²: !5, !Ğ¿ÑÑ‚ĞµÑ€Ğ¾Ñ‡ĞºĞ°, !Ğ¼Ğ°Ğ³Ğ½Ğ¸Ñ‚, !Ğ¿ĞµÑ€ĞµĞº, !Ğ»ĞµĞ½Ñ‚Ğ°, !Ğ´Ğ¸ĞºÑĞ¸\n"
)

QUOTES = [
    "ĞšĞ°Ğº ÑĞºĞ°Ğ·Ğ°Ğ» ÑÑ‚Ğ°Ñ€Ğ¸Ğº: Â«Ğ˜ÑÑ‚Ğ¸Ğ½Ğ° Ñ‚Ğ°Ğ¼, Ğ³Ğ´Ğµ Ñ‚Ğ¸ÑˆĞ¸Ğ½Ğ°Â».",
    "Ğ’ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ Ğ¼Ğ°Ğ»Ğ¾Ğ³Ğ¾ ÑˆĞ°Ğ³Ğ°.",
    "Ğ¢ĞµÑ€Ğ¿ĞµĞ½Ğ¸Ğµ Ğ¸ Ñ‚Ñ€ÑƒĞ´ Ğ²ÑÑ‘ Ğ¿ĞµÑ€ĞµÑ‚Ñ€ÑƒÑ‚.",
    "ĞĞµ Ñ‚Ğ¾Ñ‚ Ğ²ĞµĞ»Ğ¸Ğº, ĞºÑ‚Ğ¾ Ğ½Ğ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°Ğ», Ğ° Ñ‚Ğ¾Ñ‚ Ğ²ĞµĞ»Ğ¸Ğº â€” ĞºÑ‚Ğ¾ Ğ¿Ğ°Ğ´Ğ°Ğ» Ğ¸ Ğ²ÑÑ‚Ğ°Ğ²Ğ°Ğ».",
    "ĞœÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ñ Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğ¼, Ğ° Ğ¾Ğ¿Ñ‹Ñ‚ â€” Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸.",
]


ALIASES = {
    # Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ°Ğ»Ğ¸Ğ°ÑÑ‹ Ğ½Ğ° PRESETS
    "Ğ´ĞµĞ¼Ğ±ĞµĞ»ÑŒ": "Ñ‚Ğ¸Ğ¼Ğ¾Ñ…Ğ°",
}


def _normalize(word: str) -> str:
    return (word or "").strip().lower()


def get_reply(message_text: str) -> Optional[str]:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¸Ğ»Ğ¸ None, ĞµÑĞ»Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ½Ğµ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ½Ğ°."""
    word = counter._extract_bang_word(message_text)
    if not word:
        return None
    key = _normalize(word)

    # Help/menu
    if key in ("ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹", "Ğ¼ĞµĞ½Ñ", "Ñ„Ğ°ĞºÑ", "help"):
        return HELP_TEXT

    # Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ğ° / Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ AI
    if key == "Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ":
        # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ĞºĞ°Ğº ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ AI
        #context = message_text.replace(f"!{key}", "").strip()
        #if not context:
        #    context = "Ğ”Ğ°Ğ¹ Ğ¼ÑƒĞ´Ñ€Ñ‹Ğ¹ ÑĞ¾Ğ²ĞµÑ‚"
        #return get_ai_advice(context)
        return random.choice(QUOTES)

    # Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ñ‹
    if key in SHOP_LINKS:
        return f"ĞšĞ°Ñ€Ñ‚Ğ° Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ° {key}: {SHOP_LINKS[key]}"

    # ĞºÑ - ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ°
    if key == "ĞºÑ":
        return "ÑÑ‚Ğ¾ ÑÑ‚Ñ‹Ğ´Ğ½Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ñ‚ÑŒ, Ğ½Ğ¾ Ñ‚ĞµĞ¼ Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ:\n\nĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¸Ñ€ - Ğ’Ğ¸Ğ½Ğ¾Ğ³Ñ€Ğ°Ğ´Ğ¾Ğ² ĞšĞ¸Ñ€Ğ¸Ğ»Ğ» ĞĞ»ĞµĞºÑĞ°Ğ½Ğ´Ñ€Ğ¾Ğ²Ğ¸Ñ‡, +7(921)810-51-55\nĞšĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€ - ĞÑ‚Ğ°Ğ¶Ğ°Ğ½Ğ¾Ğ² Ğ¢Ğ¸Ğ¼ÑƒÑ€ Ğ¢Ğ°Ñ…Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ñ‡, +7(904)216-16-14\nĞœĞ°ÑÑ‚ĞµÑ€ - Ğ¨Ğ°Ñ€Ğ¾Ğ¹ĞºĞ¾ Ğ’Ğ»Ğ°Ğ´Ğ¸Ğ¼Ğ¸Ñ€ Ğ¡ĞµÑ€Ğ³ĞµĞµĞ²Ğ¸Ñ‡, +7(928)841-90-78"

    # Ğ±Ğ»Ğ¾Ñ…Ğ°
    if key == "Ğ±Ğ»Ğ¾Ñ…Ğ°":
        return random.choice(BLOHA_CHOICES)

    # Ğ²Ñ€ĞµĞ¼Ñ
    if key == "Ğ²Ñ€ĞµĞ¼Ñ":
        now = datetime.now(counter.TZ)
        return f"ĞšÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ: {now.strftime('%H:%M')} â€” Ğ½Ğ°ÑĞ»Ğ°Ğ¶Ğ´Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ğ¾Ğ¼."

    # ĞŸÑ€ĞµĞ´ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹ -> Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ counter.get_days_reply
    # ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ°Ğ»Ğ¸Ğ°ÑÑ‹ Ğ½Ğ° Ğ¸Ğ¼ĞµĞ½Ğ° Ğ² PRESETS
    preset_key = ALIASES.get(key, key)
    if preset_key in counter.PRESETS:
        days = counter.get_days_reply(f"!{preset_key}")
        if days is not None:
            return f"Ğ”Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ: {days} Ğ´Ğ½ĞµĞ¹"

    # ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°
    return None


if __name__ == "__main__":
    # Ğ¿Ñ€Ğ¾ÑÑ‚Ğ°Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
    samples = ["!ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹", "!Ğ´ĞµĞ¼Ğ±ĞµĞ»ÑŒ", "!ÑĞµĞ·Ğ¾Ğ½", "!Ğ·Ñ…Ğ´", "!Ğ±Ğ»Ğ¾Ñ…Ğ°", "!ĞºÑ", "!5", "!Ğ²Ñ€ĞµĞ¼Ñ"]
    for s in samples:
        print(s, "->", get_reply(s))
